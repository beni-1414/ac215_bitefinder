name: Auto-Deploy VL Model

on:
  schedule:
    - cron: "*/5 * * * *"   # every 5 minutes
  workflow_dispatch: {}      # manual trigger

jobs:
  check-and-deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    env:
      GCP_PROJECT: bitefinder-474614
      GCS_BUCKET: bitefinder-data
      BEST_MODEL_FILE: best_model.txt
      PULUMI_CONFIG_KEY: artifact_model_label

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Install gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT }}

      - name: Install Pulumi
        uses: pulumi/actions@v4

      - name: Download best_model.txt from GCS
        run: |
          gsutil cp gs://$GCS_BUCKET/$BEST_MODEL_FILE current_best_model.txt

      - name: Login to Pulumi (GCS backend)
        working-directory: src/deployment/deploy_k8s
        run: |
          pulumi login gs://bitefinder-474614-pulumi-state-bucket

      - name: Get current Pulumi artifact_model_label
        id: pulumi_config
        working-directory: src/deployment/deploy_k8s
        run: |
          CURRENT_LABEL=$(pulumi config get $PULUMI_CONFIG_KEY --stack dev || echo "none")
          echo "current_label=$CURRENT_LABEL" >> $GITHUB_OUTPUT

      - name: Compare artifact values
        id: compare
        run: |
          NEW_LABEL=$(cat current_best_model.txt)
          CURRENT_LABEL="${{ steps.pulumi_config.outputs.current_label }}"

          echo "New best_model: $NEW_LABEL"
          echo "Current Pulumi label: $CURRENT_LABEL"

          if [ "$NEW_LABEL" = "$CURRENT_LABEL" ]; then
            echo "match=true" >> $GITHUB_OUTPUT
          else
            echo "match=false" >> $GITHUB_OUTPUT
          fi

      - name: Stop if unchanged
        if: steps.compare.outputs.match == 'true'
        run: |
          echo "No changes detected â€” exiting."
          exit 0

      - name: Update Pulumi config with new artifact label
        working-directory: src/deployment/deploy_k8s
        run: |
          NEW_LABEL=$(cat ../../../current_best_model.txt)
          pulumi config set $PULUMI_CONFIG_KEY "$NEW_LABEL" --stack dev

      - name: Run Pulumi up to re-deploy
        working-directory: src/deployment/deploy_k8s
        run: |
          pulumi up --stack dev --yes
