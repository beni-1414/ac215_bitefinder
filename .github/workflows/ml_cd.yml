name: Auto-Deploy VL Model

on:
  # schedule:
  #   - cron: "*/5 * * * *" # Every 5 minutes
  workflow_dispatch: {} # Manual trigger

jobs:
  check-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    env:
      GCP_PROJECT: bitefinder-474614
      GCP_REGION: us-central1
      GCS_BUCKET: bitefinder-data
      STACK: dev

    steps:
      - name: Check out repository code
        uses: actions/checkout@v4

      - id: auth
        uses: google-github-actions/auth@v1
        with:
          credentials_json: '${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}'

      - name: Configure Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v1

      - name: Configure Docker Client
        run: gcloud auth configure-docker

      - name: Build Deployment Container
        run: |
          cd ${{ github.workspace }}/src/deployment/
          docker build -t bitefinder-deployment -f Dockerfile .

      - name: Run Deploy App
        run: |
          docker run --rm --name bitefinder-deployment \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -v $HOME/.ssh:/home/app/.ssh \
            -v "${{ github.workspace }}/src/deployment/docker_config.json":/root/.docker/config.json \
            -v "${{ github.workspace }}/src/deployment/pulumi-plugins":/root/.pulumi/plugins \
            -v ${{ github.workspace }}/src/new-frontend:/new-frontend \
            -v ${{ github.workspace }}/src/orchestrator:/orchestrator \
            -v ${{ github.workspace }}/src/ragmodel:/ragmodel \
            -v ${{ github.workspace }}/src/vlmodel:/vlmodel \
            -v ${{ github.workspace }}/src/input_evaluation:/input_evaluation \
            -v ${{ github.workspace }}/src/deployment/deploy_k8s:/deploy_k8s \
            -v ${{ github.workspace }}/src/deployment/deploy_images:/deploy_images \
            --mount type=bind,source=$GOOGLE_APPLICATION_CREDENTIALS,target=/secrets/deployment.json \
            --env GOOGLE_APPLICATION_CREDENTIALS=/secrets/deployment.json \
            -e USE_GKE_GCLOUD_AUTH_PLUGIN=True \
            -e GCP_PROJECT=$GCP_PROJECT \
            -e GCP_ZONE=us-central1-a \
            -e GCP_REGION=us-central1 \
            -e PULUMI_BUCKET=gs://$GCP_PROJECT-pulumi-state-bucket \
            bitefinder-deployment deploy_vlmodel.sh

      - name: Commit & Push updated Pulumi stack config
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          PULUMI_FILE="src/deployment/deploy_k8s/Pulumi.${STACK}.yaml"

          echo "Checking for changes in $PULUMI_FILE..."

          if [[ -n "$(git status --porcelain "$PULUMI_FILE")" ]]; then
            echo "Changes detected â€” committing $PULUMI_FILE"
            git add "$PULUMI_FILE"
            git commit -m "Auto-update Pulumi ${STACK} artifact_model_label [skip ci]"
            git push
          else
            echo "No changes to commit."
          fi
