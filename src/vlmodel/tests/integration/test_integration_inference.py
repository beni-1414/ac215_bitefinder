import pytest
import torch
from fastapi import FastAPI
from fastapi.testclient import TestClient
from api.vlmodel_router import router
import api.vlmodel_router as vl


DUMMY_IMAGE_BASE64 = """
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"
"""
DUMMY_TEXT = "I am feeling itchy and have red spots all over."


# Mock BatchEncoding for processor output
class MockBatchEncoding(dict):
    def to(self, device):
        out = {}
        for k, v in self.items():
            out[k] = v.to(device) if hasattr(v, "to") else v
        return MockBatchEncoding(out)


# Processor
class TinyProcessor:
    def __call__(self, text=None, images=None, **kwargs):
        pixel = torch.zeros(1, 3, 224, 224)
        ids = torch.tensor([[1, 2, 3]])
        return MockBatchEncoding({"pixel_values": pixel, "input_ids": ids})


# Model
class TinyModel(torch.nn.Module):
    def __init__(self):
        super().__init__()
        # fixed weights to keep outputs stable
        self.linear = torch.nn.Linear(10, 2)
        with torch.no_grad():
            self.linear.weight[:] = 0.1
            self.linear.bias[:] = 0.0
        self.processor = TinyProcessor()

    def forward(self, **kwargs):
        return {"logits": torch.tensor([[0.1, 0.9]])}


# Model patch fixture
@pytest.fixture(autouse=True)
def patch_model(monkeypatch):
    def load_dummy_model():
        vl.model = TinyModel()
        vl.model.eval()
        vl.id_to_label = {0: "label_0", 1: "label_1"}
        vl.device = "cpu"

    monkeypatch.setattr(vl, "load_model", load_dummy_model)
    load_dummy_model()


# Test client fixture
@pytest.fixture
def client():
    app = FastAPI()
    app.include_router(router)
    return TestClient(app)


def test_predict_text_raw_image_base64(client):
    payload = {"text_raw": DUMMY_TEXT, "image_base64": DUMMY_IMAGE_BASE64}
    res = client.post("/predict", json=payload)

    assert res.status_code == 200
    data = res.json()

    assert data["prediction"] == "label_1"
    assert "confidence" in data
    assert "probabilities" in data
